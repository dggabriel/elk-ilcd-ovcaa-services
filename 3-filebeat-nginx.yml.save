

---

- hosts: client_netbox
  become: true
  become_user: root
  
  vars:
    #changethis
    module_name: "nginx"
    #changethis
    ipaddress: "http://192.168.1.91"
    filename: "{{ module_name }}.yml"
  tasks:

  - name: enable module filebeat
    shell: |
     filebeat modules enable {{ module_name }}

  - name: Copy filebeat.yml
    copy:
      src: "filebeat.yml"
      dest: "/etc/filebeat/filebeat.yml"
      mode: 0600
      owner: root
      group: root

  - name: Copy module configuration
    copy:
      src: "{{ filename }}"
      dest: "/etc/filebeat/modules.d/{{ filename }}"
      mode: 0644
      owner: root
      group: root

  - name: restart filebeat
    shell: |
     systemctl restart filebeat

  - name: Replace a localhost entry searching for a literal string to avoid escaping
    ansible.builtin.lineinfile:
      path: /etc/filebeat/filebeat.yml
      search_string: "changeipaddress"
      line: {{ ipaddress }}
      owner: root
      group: root
      mode: '0600'


  #- name: Change ip address
    #lineinfile:
     #dest: /etc/filebeat/filebeat.yml
     #regexp: '^#changeipaddress\s*='
     #line: "{{ ipaddress }}"
     #state: present

  #- name: Add new configuration to "pg_hba.conf"
    #blockinfile:
     #dest: /etc/postgresql/13/main/pg_hba.conf
     #block: |
      #host    all             all             10.16.11.0/24                md5
